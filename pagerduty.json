{
  "name": "Pagerduty",
  "nodes": [
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        -1008,
        192
      ],
      "id": "e5bc982f-dea7-48c6-8f59-5b0729708636",
      "name": "When clicking ‘Execute workflow’"
    },
    {
      "parameters": {
        "jsCode": "// Get today's date in UTC\nconst today = new Date();\n\n// Get the day of week (0 = Sunday, 5 = Friday)\nconst dayOfWeek = today.getUTCDay();\n\n// Calculate days until next Friday (5)\nconst daysUntilFriday = (5 - dayOfWeek + 7) % 7;\nconst thisFriday = new Date(today);\nthisFriday.setUTCDate(today.getUTCDate() + daysUntilFriday);\nthisFriday.setUTCHours(0, 0, 0, 0);\n\n// Next Friday (7 days after this Friday)\nconst nextFriday = new Date(thisFriday);\nnextFriday.setUTCDate(thisFriday.getUTCDate() + 7);\nnextFriday.setUTCHours(23, 59, 59, 999);\n\nreturn [\n  {\n    json: {\n      since: thisFriday.toISOString(),\n      until: nextFriday.toISOString(),\n      timezone: \"UTC\"\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -784,
        192
      ],
      "id": "2c301eeb-740b-47a8-b37f-7f31e3cba890",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "jsCode": "function toToronto(dateStr) {\n  const date = new Date(dateStr);\n  // Convert UTC → EST/EDT using system offset for America/Toronto\n  const torontoOffset = new Date().toLocaleString(\"en-US\", { timeZone: \"America/Toronto\" });\n  const offsetDate = new Date(date.toLocaleString(\"en-US\", { timeZone: \"America/Toronto\" }));\n  return offsetDate;\n}\n\nfunction getWeekday(date) {\n  // Monday = 1, Sunday = 7\n  const day = date.getDay(); // Sunday = 0\n  return day === 0 ? 7 : day;\n}\n\nconst results = {\n  weekday_day: [],\n  weekday_night: [],\n  weekend: []\n};\n\nfor (const call of items[0].json.oncalls) {\n  const user = call.user?.name || \"Unknown\";\n  const start = new Date(call.start);\n  const end = new Date(call.end);\n\n  let cursor = new Date(start);\n  while (cursor < end) {\n    const local = toToronto(cursor.toISOString());\n    const weekday = getWeekday(local);\n    const hour = local.getHours();\n\n    if (weekday >= 1 && weekday <= 5) {\n      if (hour >= 8 && hour < 17) {\n        if (!results.weekday_day.includes(user)) results.weekday_day.push(user);\n      } else {\n        if (!results.weekday_night.includes(user)) results.weekday_night.push(user);\n      }\n    } else {\n      if (!results.weekend.includes(user)) results.weekend.push(user);\n    }\n\n    cursor.setHours(cursor.getHours() + 1);\n  }\n}\n\nreturn [{ json: results }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -336,
        0
      ],
      "id": "d3386510-404a-4b90-89d6-ae8913130446",
      "name": "Code in JavaScript1"
    },
    {
      "parameters": {
        "url": "https://api.pagerduty.com/oncalls",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "time_zone",
              "value": "UTC"
            },
            {
              "name": "limit",
              "value": "25"
            },
            {
              "name": "include[]",
              "value": "users"
            },
            {
              "name": "schedule_ids[]",
              "value": "PI00JYC"
            },
            {
              "name": "since",
              "value": "2025-11-07T13:00:00.000Z"
            },
            {
              "name": "until",
              "value": "2025-11-14T12:59:59.000Z"
            }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/json"
            },
            {
              "name": "Authorization",
              "value": "Token token= [SECRET TOKEN]"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {}
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -336,
        192
      ],
      "id": "ab0a916d-0a5d-4549-a9da-583f8344d0c8",
      "name": "PD VI Team"
    },
    {
      "parameters": {
        "url": "https://api.pagerduty.com/oncalls",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "time_zone",
              "value": "UTC"
            },
            {
              "name": "limit",
              "value": "25"
            },
            {
              "name": "include[]",
              "value": "users"
            },
            {
              "name": "schedule_ids[]",
              "value": "P15H7CF"
            },
            {
              "name": "since",
              "value": "2025-11-07T13:00:00.000Z"
            },
            {
              "name": "until",
              "value": "2025-11-14T12:59:59.000Z"
            }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/json"
            },
            {
              "name": "Authorization",
              "value": "Token token= [SECRET TOKEN]"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {}
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -560,
        0
      ],
      "id": "fd460eb5-1da8-4f39-9f15-205bd0098789",
      "name": "PD DevOps Team"
    },
    {
      "parameters": {
        "url": "https://api.pagerduty.com/oncalls",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "time_zone",
              "value": "UTC"
            },
            {
              "name": "limit",
              "value": "25"
            },
            {
              "name": "include[]",
              "value": "users"
            },
            {
              "name": "schedule_ids[]",
              "value": "PABJGDW"
            },
            {
              "name": "since",
              "value": "2025-11-07T13:00:00.000Z"
            },
            {
              "name": "until",
              "value": "2025-11-14T12:59:59.000Z"
            }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/json"
            },
            {
              "name": "Authorization",
              "value": "Token token= [SECRET TOKEN]"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {}
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -336,
        384
      ],
      "id": "c312d4df-f138-4b1b-aa22-6131d13e44ac",
      "name": "PD TL On-call"
    },
    {
      "parameters": {
        "chatId": "4960902742",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        64,
        192
      ],
      "id": "3580e9bd-1a29-443b-a426-f20b9ba46b37",
      "name": "Send a text message",
      "webhookId": "dfd12050-06fe-499d-957d-af74a59b25fd",
      "credentials": {
        "telegramApi": {
          "id": "HmSAfHEK75H8jMjR",
          "name": "Telegram account"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "When clicking ‘Execute workflow’": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "PD DevOps Team",
            "type": "main",
            "index": 0
          },
          {
            "node": "PD VI Team",
            "type": "main",
            "index": 0
          },
          {
            "node": "PD TL On-call",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PD DevOps Team": {
      "main": [
        [
          {
            "node": "Code in JavaScript1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PD TL On-call": {
      "main": [
        [
          {
            "node": "Send a text message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PD VI Team": {
      "main": [
        [
          {
            "node": "Send a text message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript1": {
      "main": [
        [
          {
            "node": "Send a text message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "443f116f-add7-4bd9-989f-bef0d394da8b",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "39bcf5362060bfa1153ff93d0e8b60dc64a70059aac3ab6c3926746bb8826830"
  },
  "id": "8UsVuPpoAUdRCtNi",
  "tags": []
}